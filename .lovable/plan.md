

# Fix: Duplicate Character in Scene Generation + Prompt Truncation in Edit Modal

## Problem 1: Two Identical Characters Rendered

The `scenePrompt` (used as the SCENE/Figure 1 description) contains the character's name, full dialogue, appearance details, and actions from the conversation. Then the Figure 2 block repeats the character identity again. The image model interprets this as two separate character descriptions and renders two copies of the same person.

**Example from logs:**
- Figure 1 (SCENE): "A scene showing **tammy c** at bar, my eyes dance with mischief as i take a quick selfie, lifting my breasts up..."
- Figure 2 (CHARACTER): "**tammy c**, asian beauty, beach glamour, summer vibes..."

The model sees "tammy c" described in two different Figures and draws her twice.

### Root cause locations

There are **three** paths that build `scenePrompt`, and all of them embed character identity into what should be a setting-only description:

1. **Direct action extraction** (line 2783-2791) -- builds from `sceneContext` which is fine
2. **AI narrative** (line 2802) -- generated by LLM, usually includes character
3. **Fallback** (line 2832) -- explicitly puts `sceneCharacter.name` and full conversation history into the scene description

Then at line 3100-3106, the `character_only` template wraps this as:
```
SCENE (Figure 1): <scenePrompt with character details>
CHARACTER (Figure 2): <same character again>
```

### Fix

Restructure the `character_only` prompt template (lines 3099-3107) to make Figure 1 strictly about the **environment/setting** and strip character references from the scene description. The CHARACTER block in Figure 2 should be the only place the character is described.

**Changes in `supabase/functions/roleplay-chat/index.ts`:**

1. **Add a helper function** `stripCharacterFromScenePrompt(prompt, characterName)` that removes the character's name and first-person dialogue from the scene description, leaving only setting, mood, and environmental details.

2. **Update the character_only prompt template** (lines 3099-3107):
   ```typescript
   } else {
     // Strip character identity from scene description -- Figure 2 handles character
     const settingOnly = stripCharacterFromScenePrompt(scenePrompt, sceneCharacter.name);
     
     enhancedScenePrompt = `In the setting from Figure 1, show the character from Figure 2.

   SETTING (Figure 1): ${settingOnly}

   CHARACTER (Figure 2): ${briefCharacterIdentity}

   ACTION: ${sceneContext?.actions?.[0] || 'Character in scene naturally'}`;
   }
   ```

3. **Apply same fix to POV template** (lines 3090-3098) -- same duplication risk.

4. **`stripCharacterFromScenePrompt` implementation:**
   ```typescript
   function stripCharacterFromScenePrompt(prompt: string, characterName: string): string {
     let cleaned = prompt;
     // Remove "A scene showing <name> at..." -> "at..."
     const namePattern = new RegExp(
       `A scene showing ${characterName}\\s+(at|in|on|near|by)`,
       'gi'
     );
     cleaned = cleaned.replace(namePattern, '$1');
     // Remove character name mentions
     cleaned = cleaned.replace(new RegExp(characterName, 'gi'), 'the character');
     // Remove "Recent context: ..." block (dialogue belongs in ACTION, not SETTING)
     cleaned = cleaned.replace(/Recent context:.*$/s, '').trim();
     // Clean up
     cleaned = cleaned.replace(/^[,.\s]+/, '').trim();
     if (!cleaned || cleaned.length < 10) {
       // If stripping removed too much, return a minimal setting description
       const settingMatch = prompt.match(/at\s+(\w[\w\s]+?)(?:,|\.|\s+the\s)/i);
       return settingMatch ? settingMatch[1].trim() : 'the current scene';
     }
     return cleaned;
   }
   ```

## Problem 2: Prompt Truncated in Edit Modal

The `ScenePromptEditModal` textarea likely has a limited height or the `fal_prompt` stored in `generation_metadata` isn't being displayed fully.

**Changes in `src/components/roleplay/ScenePromptEditModal.tsx`:**
- Increase the textarea `rows` or use `min-h-[300px]` to show full prompts without scrolling confusion.

## Problem 3: Conversation History in Scene Prompt is Too Verbose

The fallback path (line 2832) dumps `conversationHistory.slice(-5).join(' | ')` into the scene prompt. This creates prompts over 2000 characters that are mostly dialogue, not visual instructions.

**Fix:** Limit the "Recent context" to the last 2 messages (not 5), and cap total scenePrompt to 500 characters before it enters the Figure notation template.

## Files Modified

| File | Change |
|------|--------|
| `supabase/functions/roleplay-chat/index.ts` | Add `stripCharacterFromScenePrompt()` helper; update character_only and POV prompt templates to separate setting from character; cap fallback context length |
| `src/components/roleplay/ScenePromptEditModal.tsx` | Increase textarea height for full prompt visibility |

## Redeploy

The `roleplay-chat` edge function must be redeployed after changes.

